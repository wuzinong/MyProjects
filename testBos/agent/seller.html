<!DOCTYPE html>
<html lang="zh-Hans">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>下属</title>
    <link rel="shortcut icon" href="favicon.ico">
    <link href="../public/admin/plugins/Hplus-v.4.1.0/css/bootstrap.min.css?v=3.3.6" rel="stylesheet">
    <link rel="stylesheet" href="../public/admin/plugins/iconfont/iconfont.css">

    <link href="../public/admin/plugins/Hplus-v.4.1.0/css/plugins/bootstrap-table/bootstrap-table.min.css"
          rel="stylesheet">
    <link rel="stylesheet" href="../public/admin/plugins/bootstrap3-editable/css/bootstrap-editable.css">

    <link rel="stylesheet" href="../public/admin/css/p-waiter.css?rev=@@hash">
</head>
<body class="gray-bg">
<div class="row wrapper border-bottom white-bg page-heading">
    <div class="col-lg-9">
        <h2>二级合作商
            <small class="g-fs--12 text-muted">（若新的商家由某二级合作商介绍进来，别忘记在右侧【关联商家】中，找到该商家并绑定二级合作商）</small>
        </h2>
        <!--<ol class="breadcrumb">
            <li>
                <a href="/agentAdmin/index/dashboard">主页</a>
            </li>
            <li class="active">
                <strong>下属</strong>
            </li>
        </ol>-->
    </div>
</div>
<div class="wrapper wrapper-content">
    <!--打赏数据图表 start-->
    <!--     <div class="row">
        <div class="col-sm-4">
            <div class="ibox float-e-margins">
                <div class="ibox-title"><span class="label label-info pull-right">总</span>
                    <h5>商家总数</h5>
                </div>
                <div class="ibox-content">
                    <h1 class="no-margins">22</h1>
                    <small class="stat-title">数量</small>
                    <div class="stat-percent font-bold text-info">22家<i class="iconfont icon-bolt"></i></div>
                </div>
            </div>
        </div>
        <div class="col-sm-4">
            <div class="ibox float-e-margins">
                <div class="ibox-title"><span class="label label-info pull-right">总</span>
                    <h5>下属数量</h5>
                </div>
                <div class="ibox-content">
                    <h1 class="no-margins">22</h1>
                    <small class="stat-title">数量</small>
                    <div class="stat-percent font-bold text-info">22人<i class="iconfont icon-bolt"></i></div>
                </div>
            </div>
        </div>
        <div class="col-sm-4">
            <div class="ibox float-e-margins">
                <div class="ibox-title"><span class="label label-info pull-right">总</span>
                    <h5>下属关联商家</h5>
                </div>
                <div class="ibox-content">
                    <h1 class="no-margins">5</h1>
                    <small class="stat-title">数量</small>
                    <div class="stat-percent font-bold text-info">5家<i class="iconfont icon-bolt"></i></div>
                </div>
            </div>
        </div>
    </div> -->
    <!--打赏数据图表 end-->
    <div class="row">
        <div class="col-md-8">
            <!--最新打赏 start-->
            <div class="ibox">
                <div class="ibox-title">
                    <h5>二级合作商管理</h5>
                    <div class="ibox-tools">
                        <a class="collapse-link">
                            <i class="iconfont icon-packup"></i>
                        </a>
                    </div>
                </div>
                <div class="ibox-content">
                    <div class="row g-mb--10">
                        <div class="col-sm-6 col-lg-4 col-lg-offset-8 col-sm-offset-6">
<!--                             <div class="input-group">
    <input class="form-control" type="text">
    <span class="input-group-btn">
            <button class="btn btn-primary" type="button">搜索</button>
          </span>
</div> -->
                        </div>
                    </div>
                    <table class="table table-bordered">
                        <thead>
                        <tr>
                            <th>姓名</th>
                            <th>打赏比例</th>
                            <th>范围</th>
                            <th>手机</th>
                            <th>操作</th>
                        </tr>
                        </thead>
                        <tbody>
                        <?php if (!empty($sellerList)): foreach ($sellerList as $seller): ?>
                            <tr data-psssword="<?php echo $seller['password']?>" data-sellerId="<?php echo $seller['seller_id'] ?>" data-range="<?php echo $seller['range']?>">
                                <td><?php echo $seller['name'] ?></td>
                                <td><?php echo $seller['share'] * 100 ?>%</td>
                                <td><?php echo $seller['range'] ?></td>
                                <td><?php echo $seller['mobile'] ?></td>
                                <td>
                                    <div class="btn-group">
                                        <button type="button" class="btn btn-primary btn-sm dropdown-toggle"
                                                data-toggle="dropdown">操作<span class="caret"></span></button>
                                        <ul class="dropdown-menu">
                                            <li><a class="js-seller-set" href="javascript:;">修改</a></li>
                                            <li><a class="js-seller-del" href="javascript:;">删除</a></li>
                                        </ul>
                                    </div>
                                </td>
                            </tr>
                        <?php endforeach;endif; ?>
                        </tbody>
                    </table>
                    <div class="m-table-pagination g-clearfix g-m--0">
                        <!--                         <div class="pull-left m-pagination-detail">
                            <span class="m-pagination-info">显示第 1 到第 3 条记录，总共 11 条记录</span>
                            <div class="m-page-list">每页显示
                                <span class="btn-group dropup">
                                <button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown" aria-expanded="false">
                                    <span class="page-size">10</span>
                                    <span class="caret"></span>
                                </button>
                                    <ul class="dropdown-menu" role="menu">
                                        <li class="active">
                                            <a href="javascript:;">10</a></li>
                                        <li>
                                            <a href="javascript:;">25</a>
                                        </li>
                                    </ul>
                                </span> 条记录
                            </div>
                        </div> -->
                        <div id="pagination_container" class="pull-right pagination">
                        </div>
                    </div>
                </div>
                <div class="ibox-footer g-ta--r">
                    <button id="js-btn-addSeller" type="button" class="btn btn-primary js-gift-add">新增二级合作商</button>
                </div>
            </div>
            <!--最新打赏 end-->
        </div>
        <div class="col-md-4">
            <!--礼物设置 start-->
            <div class="ibox">
                <div class="ibox-title">
                    <h5>关联商家</h5>
                    <div class="ibox-tools">
                        <a class="collapse-link">
                            <i class="iconfont icon-packup"></i>
                        </a>
                    </div>
                </div>
                <div class="ibox-content m-ibox-overflow-y">
                    <div class="m-overflow_inner" style="height: 633px;">
                    <div class="row g-mb--10">
                        <div class="col-sm-12 col-md-8 col-md-offset-4">
<!--                             <div class="input-group">
    <input class="form-control" type="text">
    <span class="input-group-btn">
            <button class="btn btn-primary" type="button">搜索</button>
          </span>
</div> -->
                        </div>
                    </div>
                    <table class="table table-bordered">
                        <colgroup>
                            <col style="width:80px">
                            <col>
                            <col style="width:105px">
                        </colgroup>
                        <thead>
                        <tr>
                            <th>店名</th>
                            <th>地址</th>
                            <th>绑定二级合作商</th>
                        </tr>
                        </thead>
                        <tbody>
                        <?php if (!empty($shopList)): foreach ($shopList as $shop): ?>
                            <tr data-shopId="<?php echo $shop['shop_id']?>">
                                <td><?php echo $shop['name'] ?></td>
                                <td><?php echo $shop['area_name'] . $shop['address'] ?></td>
                                <td>
                                    <select name="" class="form-control js-agent-second">
                                        <option value="0">未绑定</option>
                                        <?php if (!empty($allSellerList)):foreach ($allSellerList as $seller): ?>
                                            <option value="<?php echo $seller['seller_id'] ?>" <?php if($shop['seller_id']==$seller['seller_id']):?>selected<?php endif;?>><?php echo $seller['name'] ?></option>
                                        <?php endforeach;endif; ?>
                                    </select>
                                </td>
                            </tr>
                        <?php endforeach;endif; ?>
                        </tbody>
                    </table>
                    </div>
                </div>
            </div>
            <!--礼物设置 end-->
        </div>
    </div>

</div>
<!--弹出层-->
<!--下属-->
<div id="seller-set" class="modal fade">
    <form action="">
        <div class="modal-dialog">
            <div class="modal-content form-horizontal animated flipInY">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span>
                    </button>
                    <h4 class="modal-title">二级合作商</h4>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-sm-6">
                            <input type="hidden" name="" id="seller_id">
                            <div class="form-group">
                                <label for="" class="col-sm-4 control-label"><span class="g-c--red">*</span>姓名</label>
                                <div class="col-sm-8">
                                    <input id="js-name" type="text" class="form-control">
                                    <span class="help-block g-mb--0 hide">提示语句</span>
                                </div>
                            </div>
                        </div>
                        <div class="col-sm-6">
                            <div class="form-group">
                                <label for="" class="col-sm-4 control-label"><span class="g-c--red">*</span>打赏</label>
                                <div class="col-sm-8">
                                    <div class="input-group">
                                        <input id="js-share" type="number" class="form-control">
                                        <span class="input-group-addon">%</span>
                                    </div>
                                    <span class="help-block g-mb--0">二级合作商分成比例，请填写0~100的整数</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-sm-6">
                            <div class="form-group">
                                <label for="" class="col-sm-4 control-label"><span class="g-c--red">*</span>手机</label>
                                <div class="col-sm-8">
                                    <input id="js-mobile" type="tel" required pattern="^(0|86|17951)?(13[0-9]|15[012356789]|17[0678]|18[0-9]|14[57])[0-9]{8}" class="form-control js-input-tel">
                                    <span class="help-block g-mb--0 js-tel-error text-danger hide">手机号码错误</span>
                                </div>
                            </div>
                        </div>
                        <div class="col-sm-6">
                            <div class="form-group">
                                <label for="" class="col-sm-4 control-label"><span class="g-c--red">*</span>密码</label>
                                <div class="col-sm-8">
                                    <input id="js-password" type="password" class="form-control ">

                                    <span class="help-block g-mb--0 hide">提示语句</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-sm-12">
                            <div class="form-group">
                                <label for="" class="col-sm-2 control-label"><span class="g-c--red">*</span>范围</label>
                                <div class="col-sm-10">
                                    <input id="js-range" type="text"  class="form-control js-input-range">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button id="js-addSeller" type="button" class="btn btn-primary js-btn-seller">保存</button>
                    <button type="button" class="btn btn-default" data-dismiss="modal">关闭</button>
                </div>
            </div>
        </div>
    </form>
</div>

<!-- 全局js -->
<script src="../public/admin/plugins/Hplus-v.4.1.0/js/jquery.min.js?v=2.1.4"></script>
<script src="../public/admin/plugins/Hplus-v.4.1.0/js/bootstrap.min.js?v=3.3.6"></script>


<!--ECharts-->
<!--<script src="../public/admin/plugins/Hplus-v.4.1.0/js/plugins/echarts/echarts.js?v=3.6"></script>-->

<!-- 自定义js -->
<script src="../public/admin/plugins/Hplus-v.4.1.0/js/content.js?v=1.0.0"></script>

<!-- GITTER -->
<script src="../public/admin/plugins/Hplus-v.4.1.0/js/plugins/gritter/jquery.gritter.min.js"></script>

<!-- Bootstrap table -->
<script src="../public/admin/plugins/Hplus-v.4.1.0/js/plugins/bootstrap-table/bootstrap-table.min.js"></script>
<script src="../public/admin/plugins/Hplus-v.4.1.0/js/plugins/bootstrap-table/locale/bootstrap-table-zh-CN.min.js"></script>

<script src="../public/admin/plugins/bootstrap3-editable/js/bootstrap-editable.min.js"></script>

<!--bootstrap dropdown-->
<script src="../public/admin/plugins/bootstrap/js/bootstrap-hover-dropdown.min.js"></script>

<!-- layerDate plugin javascript -->
<script src="../public/admin/plugins/laydate/laydate.js"></script>
<script src="../public/admin/plugins/layer/layer.js"></script>

<script src="../public/admin/js/m-ibox.js?ver=1004"></script>
<script>
$(function () {
    /*时间选择*/
    //日期范围
    laydate.render({
        elem: '.js-data-select'
        , range: true
    });
    /*增加下属*/
    $("#js-btn-addSeller").on('click', function () {
        $("#seller-set").modal();
        $(".js-btn-seller").attr('id', 'js-addSeller');
        $("#js-name").val('');
        $("#js-mobile").val('');
        $("#js-password").val('');
        $("#js-share").val('');
        $("#js-range").val('');
    });
    $(".modal").on('click', '#js-addSeller', function () {
        var reg = new RegExp("^(\\d|[1-9]\\d|100)$");
        var name = $("#js-name").val();
        var mobile = $("#js-mobile").val();
        var password = $("#js-password").val();
        var old_share = $("#js-share").val();
        var share = old_share*0.01;
        var range=$("#js-range").val();
        console.log(name);
        console.log(mobile);
        console.log(password);
        console.log(share);
        console.log(range);
        if(!reg.test(old_share)) {
            layer.msg("打赏分成比例请输入0-100的整数！",{
                anim:0,
                time:1000
            },function(){
                $("#js-share").val('');
            });
            return false;
        }
        if (!name == '' && !mobile == '' && !password == '' && !range=='') {

            $.ajax({
                type:'POST',
                url:'/agentAdmin/seller/addSeller',
                dataType:'json',
                data:{
                    name:name,
                    mobile:mobile,
                    password:password,
                    share:share,
                    range:range,
                },
                success:function (data) {
                    if(data.code===200){
                        $("#seller-set").modal('hide');
                        layer.msg('添加成功',{
                            anim:0,
                            time:1000
                        },function () {
                            window.location.reload(true);
                        })
                    }else if(data.code===400){
                        layer.msg(data.message);
                    }
                },
                error:function (jqXHR) {
                    console.log("发生错误"+jqXHR.status);
                }
            });
        }else{
            layer.msg('请正确填写选项',{
                time:1000
            });
        }
    });
    /*修改下属*/
    $(".table").on('click','.js-seller-set',function () {
        var $this_tr=$(this).closest("tr");
        var this_seller_id=$this_tr.attr('data-sellerid');
        var password=$this_tr.attr('data-psssword');
        var range=$this_tr.attr('data-range');
        var this_name=$.trim($this_tr.find("td:eq(0)").text());
        var share_arr=$.trim($this_tr.find("td:eq(1)").text()).split('%');
        var this_share=share_arr[0];
        var this_mobile=$.trim($this_tr.find("td:eq(3)").text());
        $("#seller-set").modal();
        $(".js-btn-seller").attr('id', 'js-setSeller');
        $("#seller_id").val(this_seller_id);
        $("#js-name").val(this_name);
        $("#js-share").val(this_share);
        $("#js-mobile").val(this_mobile);
        $("#js-password").val(password);
        $("#js-range").val(range);
    });
    $(".modal").on('click','#js-setSeller',function () {
        var reg = new RegExp("^(\\d|[1-9]\\d|100)$");
        var name = $("#js-name").val();
        var mobile = $("#js-mobile").val();
        var password = $("#js-password").val();
        var old_share = $("#js-share").val();
        var share = old_share*0.01;
        var seller_id=$("#seller_id").val();
        var range=$("#js-range").val();
        console.log(name);
        console.log(mobile);
        console.log(password);
        console.log(share);
        console.log(seller_id);
        if(!reg.test(old_share)) {
            layer.msg("打赏分成比例请输入0-100的整数！",{
                anim:0,
                time:1000
            },function(){
                $("#js-share").val('');
            });
            return false;
        }
        if (!name == '' && !mobile == '' && !password == '' &&!range=='') {
            $.ajax({
                type:'POST',
                url:'/agentAdmin/seller/updateSeller',
                dataType:'json',
                data:{
                    seller_id:seller_id,
                    name:name,
                    mobile:mobile,
                    password:password,
                    share:share,
                    range:range,
                },
                success:function (data) {
                    if(data.code===200){
                        $("#seller-set").modal('hide');
                        layer.msg('编辑成功',{
                            anim:0,
                            time:1000
                        },function () {
                            window.location.reload(true);
                        })
                    }else if(data.code===400){
                        layer.msg(data.message);
                    }
                },
                error:function (jqXHR) {
                    console.log("发生错误"+jqXHR.status);
                }
            });
        }else{
            layer.msg('请正确填写选项',{
                time:1000
            });
        }
    });
    /*删除下属*/
    $(".table").on('click','.js-seller-del',function () {
        var $this_tr=$(this).closest("tr");
        var seller_id=$this_tr.attr('data-sellerid');
        $.ajax({
            type:'POST',
            url:'/agentAdmin/seller/deleteSeller',
            dataType:'json',
            data:{
                seller_id:seller_id,
            },
            success:function (data) {
                if(data.code==200){
                    $this_tr.remove();
                    layer.msg('删除成功',{
                        time:1000,
                        anim:0
                    });
                }else if(data.code===400){
                    layer.msg(data.messgae);
                }
            },
            error:function (jqXHR) {
                console.log("发生错误"+jqXHR.status);
            }
        });
    });
    /*店铺绑定下属*/
    var agent_second = [];
    $.each($(".js-agent-second"), function () {
        var select_val = $(this).val();
        agent_second.push(select_val);
//           console.log(agent_second);
    });
    $(".table").on('change', '.js-agent-second', function () {
        var $this = $(this);
        var num = $this.closest('tr').index();
        var old_val = agent_second[num];
        var new_val = $this.val();
        var question_text;
        var shop_id=$this.closest('tr').attr('data-shopId');
        var seller_id=new_val;
            console.log(shop_id+"||"+seller_id);
        if(new_val=='0'){
            question_text='确定要解绑吗？';
        }else{
            question_text='确定要绑定吗？'
        }
        layer.confirm(question_text, {icon: 3}, function (index) {
            //删除tr
//                prizeSelect($this);
            agent_second.splice(num, 1, new_val);
            layer.close(index);
            $.ajax({
                type:'POST',
                url:'/agentAdmin/seller/bindSeller',
                dataType:'json',
                data:{
                    shop_id:shop_id,
                    seller_id:seller_id,
                },
                success:function (data) {
                    if(data.code===200){
                        layer.msg('操作成功',{
                            anim:0,
                            time:1000
                        });
                    }else if(data.code===400){
                        layer.msg(data.message);
                    }
                },
                error:function (jqXHR) {
                    console.log(jqXHR.status);
                }
            });
        }, function (index) {
            $this.val(old_val);
            layer.close(index);
        });
    });
});
</script>
<script type="text/javascript" src="../public/admin/js/admin_pagination.js"></script>
<!--<script src="../public/admin_mobile/js/p-business-index.js?rev=a64e9c129dd8a20f9620102a074ed2f7"></script>-->
<script>
    $(function () {
        setPage(document.getElementById('pagination_container'), <?php echo $pagecount?>, <?php echo $curpage?>, '/shopAdmin/evaluation/stats', []);
    });
</script>
</body>
</html>